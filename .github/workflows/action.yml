name: Recent Contributions

permissions:
  contents: write

on:
  schedule:
    - cron: "*/30 * * * *"  # every 30 minutes
  workflow_dispatch:

jobs:
  check_github_contribution:
    runs-on: ubuntu-latest
    outputs:
      contributed: ${{ steps.check.outputs.contributed }}
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check github recent contributions
        id: check
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          USERNAME: nihaltp
        run: |
          START=$(date -u -d '30 minutes ago' +"%Y-%m-%dT%H:%M:%SZ")
          END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          QUERY=$(jq -n \
            --arg start "$START" \
            --arg end "$END" \
            --arg username "$USERNAME" \
            '{query: "query { user(login: \"\($username)\") { contributionsCollection(from: \"\($start)\", to: \"\($end)\") { totalCommitContributions totalPullRequestContributions totalIssueContributions totalPullRequestReviewContributions } } }"}')

          RESPONSE=$(curl -s -H "Authorization: bearer $GH_TOKEN" \
                           -X POST -d "$QUERY" https://api.github.com/graphql)

          echo "$RESPONSE"

          COMMITS=$(echo "$RESPONSE" | jq '.data.user.contributionsCollection.totalCommitContributions')
          PRS=$(echo "$RESPONSE" | jq '.data.user.contributionsCollection.totalPullRequestContributions')
          ISSUES=$(echo "$RESPONSE" | jq '.data.user.contributionsCollection.totalIssueContributions')
          REVIEWS=$(echo "$RESPONSE" | jq '.data.user.contributionsCollection.totalPullRequestReviewContributions')

          TOTAL=$((COMMITS + PRS + ISSUES + REVIEWS))

          echo "Commits: $COMMITS"
          echo "PRs: $PRS"
          echo "Issues: $ISSUES"
          echo "Reviews: $REVIEWS"
          echo "Total contributions in last 30 min: $TOTAL"

          if [ "$TOTAL" -gt 0 ]; then
            echo "contributed=true" >> $GITHUB_OUTPUT
          else
            echo "contributed=false" >> $GITHUB_OUTPUT
          fi

  check_monkeytype_contribution:
    runs-on: ubuntu-latest
    outputs:
      contributed: ${{ steps.check.outputs.contributed }}
    steps:
      - name: Check monkeytype recent contributions
        id: check
        env:
          USERNAME: nihaltp
        run: |
          RESPONSE=$(curl -s "https://api.monkeytype.com/users/${USERNAME}/profile?isUid=false")
          TOTAL=$(echo $RESPONSE | jq '.data.testActivity.testsByDays | .[-1:] | add // 0')

          if [ "$TOTAL" -gt 0 ]; then
            echo "contributed=true" >> $GITHUB_OUTPUT
          else
            echo "contributed=false" >> $GITHUB_OUTPUT
          fi

  run_snake:
    needs: check_github_contribution
    if: needs.check_github_contribution.outputs.contributed == 'true'
    permissions:
      contents: write
    uses: ./.github/workflows/snake.yml

  run_monkeytype_snake:
    needs: check_monkeytype_contribution
    if: needs.check_monkeytype_contribution.outputs.contributed == 'true'
    permissions:
      contents: write
    uses: ./.github/workflows/monkeytype.yml
